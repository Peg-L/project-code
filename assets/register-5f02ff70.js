import{a as c}from"./backtotop-61d0d527.js";import{R as w,a as d,s as L,h as i,b as S,G as V,p as q}from"./login-a5a70342.js";function E(e){e.classList.remove("is-valid"),e.classList.add("is-invalid")}function u(e){e.classList.remove("is-invalid"),e.classList.add("is-valid")}let n={email:"",password:"",phone:"",name:"",role:"學生",title:"",avatar:"https://raw.githubusercontent.com/Peg-L/project-code/0a1e1a3dcd659bc9a4c72332f12ef660630a103e/assets/images/logo-img.svg",birthdate:"",gender:"",address:"",followList:[]};function k(e){const t=e.target.form;n={email:t.Email.value,password:t.密碼.value,phone:t.手機.value,name:t.姓名.value,role:"學生",title:"",avatar:t.頭像?t.頭像.value:"https://raw.githubusercontent.com/Peg-L/project-code/0a1e1a3dcd659bc9a4c72332f12ef660630a103e/assets/images/logo-img.svg",birthdate:"",gender:"",address:"",followList:[]}}const l=document.querySelector("#registerBtn"),h=/^09\d{8}$/,C=/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/,R=/^\d{6}$/,j={Email:{presence:{message:"Email 為必填"},email:{message:"Email 格式不符"}},密碼:{presence:{message:"密碼為必填"},format:{pattern:C,message:"密碼格式不符"}},確認密碼:{presence:{message:"確認密碼為必填"},equality:{attribute:"密碼",message:"確認密碼與密碼不符"}},手機:{presence:{message:"手機為必填"},format:{pattern:h,message:"手機格式不符"}},驗證碼:{presence:{message:"驗證碼為必填"},format:{pattern:R,message:"驗證碼格式不符"}},姓名:{presence:{message:"姓名為必填"}}},x=document.querySelector("#registerForm"),D=document.querySelectorAll("input[type=email], input[type=text], input[type=tel], input[type=password]");function P(){D.forEach(e=>{e.addEventListener("change",function(){const t=e.name;document.querySelector(`p[data-message="${t}"]`).textContent="";let s=validate(x,j,{fullMessages:!1});s?(document.querySelector(`[data-message="${t}"]`).textContent=s[t],l.setAttribute("disabled","true"),s[t]?E(e):u(e)):(u(e),l.removeAttribute("disabled"));const o=document.querySelector('[name="手機"]');h.test(o.value)?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled")})})}P();const v=document.querySelector("#inputVerifyCode");window.recaptchaVerifier=new w(d,"verify-button",{size:"invisible",callback:e=>{console.log("res：",e)}});function $(){return document.querySelector("#floatingTel").value}let m;const a=document.querySelector("#sendCode"),p=document.querySelector("#sendCodeSpinner"),F=window.recaptchaVerifier;a.addEventListener("click",function(){p.classList.remove("d-none"),m="+886"+$(),L(d,m,F).then(t=>{v.classList.remove("d-none"),p.classList.add("d-none"),window.confirmationResult=t,console.log(window.confirmationResult)}).catch(t=>{console.log("signInWithPhoneNumber error",t),t=="FirebaseError: Firebase: Invalid format. (auth/invalid-phone-number)."&&alert("手機格式不符，請重新輸入"),grecaptcha.reset(window.recaptchaWidgetId),window.recaptchaVerifier.render().then(function(s){grecaptcha.reset(s)})})});function N(){return document.querySelector("#floatingVerifyCode").value}let g;const A=document.querySelector("#verify-button"),I=document.querySelector("#verifySuccessMsg");A.addEventListener("click",function(){g=N(),confirmationResult.confirm(g).then(e=>{e.user,v.classList.add("d-none"),I.classList.remove("d-none"),a.classList.add("d-none")}).catch(e=>{console.log("confirm error",e)})});l.addEventListener("click",function(e){e.preventDefault(),k(e),y(n,!1)});function T(e){let t=e.match(/^(.)(.*)(.)@(.+)$/);return t[1]+"******"+t[3]+"@"+t[4]}async function U(e){try{const t={headers:{"Content-Type":"application/json"}};let s=Date.now(),o=new Date(s);o.setDate(o.getDate()+30),o.setHours(23,59,59,999);const r={userId:e,couponId:1,canUse:!0,timestamp:s,dueDate:o},b={userId:e,purchased:[],attendTime:[]};await Promise.all([c.post("https://project-code-json-k0ti.onrender.com/myCoupons",r,t),c.post("https://project-code-json-k0ti.onrender.com/user_courses",b,t)])}catch(t){console.log("postNewUserRelatedData",t)}}function y(e,t){c.post("https://project-code-json-k0ti.onrender.com/users",e).then(s=>{let o=T(e.email);const r=document.querySelector("#emailVerified");r.innerHTML=`<p class="mb-4">
我們已寄送一封帳號驗證信至您的信箱
<br />
${o}
</p>
<p class="mb-10">
請點擊驗證信的「<strong>連結</strong>」來開通帳號
</p>
<div
class="text-center mb-2 d-flex justify-content-between align-items-center"
>
<span>沒收到信嗎?</span>
<button
  type="button"
  class="btn btn-outline-secondary2 rounded-1 py-2"
>
  重新寄送驗證信
</button>
</div>`,U(s.data.user.id),t?i(e,!0):i(e,!1)}).catch(s=>{console.error("handleRegister error",s),s.response.data=="Email already exists"&&(t?(console.log("轉 google 登入"),i(e,!0)):Swal.fire({icon:"error",title:"此帳號已註冊",text:"請前往登入頁面或註冊新帳號"}))})}const f=document.querySelector("#google-register");f&&f.addEventListener("click",function(){S(d,q).then(e=>{V.credentialFromResult(e).accessToken;const s=e.user;console.log("user",s),n.email=s.email,n.password="00000000",n.name=s.displayName,n.phone=s.phoneNumber,n.avatar=s.photoURL,y(n,!0)}).catch(e=>{console.error(e)})});
