import{a as h}from"./backtotop-7745fe90.js";import{s as I,G as D,R as P,a as w,b as $,p as j}from"./firebase-9e2df465.js";function l(e){e.classList.remove("is-valid"),e.classList.add("is-invalid")}function c(e){e.classList.remove("is-invalid"),e.classList.add("is-valid")}let d=document.querySelector("#floatingEmail"),u=document.querySelector("#floatingName"),p=document.querySelector("#floatingTel"),r=document.querySelector("#floatingPassword"),m=document.querySelector("#floatingCheckPassword");d.addEventListener("input",A);u.addEventListener("input",N);p.addEventListener("input",T);r.addEventListener("input",F);m.addEventListener("input",U);const o={email:"",password:"",user_phone:"",user_name:"",user_role:"學生",user_title:"",user_avatar:"",user_birthdate:"",user_gender:"",user_address:"",followList:[]};let k=!1,L=!1,R=!1,C=!1,x=!1,E=!1;function A(){const e=d.value;o.email=e,/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(e)?(c(d),k=!0):l(d),a()}function N(){const e=u.value;o.user_name=e,/^.{1,20}$/.test(e)?(c(u),L=!0):l(u),a()}function T(){const e=p.value;o.user_phone=e,/^09\d{8}$/.test(e)?(c(p),R=!0,i.removeAttribute("disabled")):(l(p),i.setAttribute("disabled","disabled")),a()}function F(){const e=r.value;o.password=e,/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/.test(e)?(c(r),C=!0):l(r),a()}function U(){let e=r.value,t=m.value;console.log("passwordCheckValue：",t),t==e&&t?(c(m),x=!0):l(m),a()}function B(e){let t=e.match(/^(.)(.*)(.)@(.+)$/);return t[1]+"******"+t[3]+"@"+t[4]}function q(e,t){h.post("https://project-code-json-k0ti.onrender.com/users",e).then(n=>{console.log(n.data);let s=B(e.email);const f=document.querySelector("#emailVerified");f.innerHTML=t?"":`<p class="mb-4">
我們已寄送一封帳號驗證信至您的信箱
<br />
${s}
</p>
<p class="mb-10">
請點擊驗證信的「<strong>連結</strong>」來開通帳號
</p>
<div
class="text-center mb-2 d-flex justify-content-between align-items-center"
>
<span>沒收到信嗎?</span>
<button
  type="button"
  class="btn btn-outline-secondary2 rounded-1 py-2"
>
  重新寄送驗證信
</button>
</div>`,new bootstrap.Modal("#registerSuccess").show(),M(n.data.user.id)}).catch(n=>{console.error(n),n.response.data=="Email already exists"&&Swal.fire({icon:"error",title:"此帳號已註冊",text:"請前往登入頁面或註冊新帳號"})})}async function M(e){try{const t={headers:{"Content-Type":"application/json"}};let n=Date.now(),s=new Date(n);s.setDate(s.getDate()+30),s.setHours(23,59,59,999);const f={userId:e,couponId:1,canUse:!0,timestamp:n,dueDate:s},v={userId:e,purchased:[],attendTime:[]};await Promise.all([h.post("https://project-code-json-k0ti.onrender.com/myCoupons",f,t),h.post("https://project-code-json-k0ti.onrender.com/user_courses",v,t)])}catch(t){console.log("postNewUserRelatedData",t)}}const g=document.querySelector("#registerBtn");function a(){k&&L&&R&&C&&x&&E?g.removeAttribute("disabled"):g.setAttribute("disabled","true")}a();g.addEventListener("click",function(e){e.preventDefault(),q(o,!1)});const b=document.querySelector("#google-register");b&&b.addEventListener("click",function(){I(w,j).then(e=>{D.credentialFromResult(e).accessToken;const n=e.user;console.log(n),o.email=n.email,o.password="00000000",o.user_name=n.email,o.user_phone=n.phoneNumber,o.user_avatar=n.photoURL,q(o,!0)}).catch(e=>{console.error(e)})});const _=document.querySelector("#inputVerifyCode");window.recaptchaVerifier=new P(w,"verify-button",{size:"invisible",callback:e=>{console.log("res：",e)}});function W(){return document.querySelector("#floatingTel").value}let y;const i=document.querySelector("#sendCode"),V=document.querySelector("#sendCodeSpinner"),z=window.recaptchaVerifier;i.addEventListener("click",function(){V.classList.remove("d-none"),y="+886"+W(),$(w,y,z).then(e=>{console.log("手機驗證"),_.classList.remove("d-none"),V.classList.add("d-none"),window.confirmationResult=e,console.log(window.confirmationResult)}).catch(e=>{e=="FirebaseError: Firebase: Invalid format. (auth/invalid-phone-number)."&&alert("手機格式不符，請重新輸入"),grecaptcha.reset(window.recaptchaWidgetId),window.recaptchaVerifier.render().then(function(t){grecaptcha.reset(t)})})});function G(){return document.querySelector("#floatingVerifyCode").value}let S;const H=document.querySelector("#verify-button");H.addEventListener("click",function(){S=G(),confirmationResult.confirm(S).then(e=>{const t=e.user;console.log("user",t),E=!0,_.classList.add("d-none"),i.textContent="驗證成功",i.setAttribute("disabled","disabled"),a()}).catch(e=>{console.log(e)})});
