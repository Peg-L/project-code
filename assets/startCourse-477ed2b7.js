import{i as m,u as c,a as r,g as C,r as f}from"./backtotop-257d1cbf.js";let i;const u=Swal.mixin({icon:"success",toast:!0,position:"top-end",showConfirmButton:!1,timer:2e3});let l,h,d,p;function B(e){document.addEventListener("DOMContentLoaded",()=>{e.addEventListener("click",async t=>{if(t.target.dataset.course&&t.target.type==="button")if(m){i=t.target.dataset.course;const a=Number(t.target.dataset.quantity)||1;await y(),p=h.find(o=>o.couponId==d[0].id)!==void 0,w(a),I(),g()}else{let s=function(){o&&(a==0&&(location.href="./login.html"),document.getElementById("timeBox").innerHTML=a,a-=1,setTimeout(s,1e3))},a=5,o=!0;document.getElementById("timeBox").innerHTML=a,document.querySelector("#btn-close").addEventListener("click",function(){o=!1}),s()}})})}async function y(){try{const e=`http://localhost:3000/myCarts?userId=${c}&courseId=${i}&status=purchase`,t=`http://localhost:3000/myCoupons?userId=${c}`,a=`http://localhost:3000/coupons?courseId=${i}`,o=await Promise.all([r.get(e),r.get(t),r.get(a)]);l=o[0].data,h=o[1].data,d=o[2].data}catch{console.log("getStartCourseData",y)}}async function g(){p?u.fire({title:"將課程加入購物車"}):(await u.fire({title:"將課程加入購物車"}),u.fire({title:"首次加入購物車，獲得「體驗課優惠券」、「多堂折價優惠券」"}))}function w(e){l.length?$(l[0],e):D(e)}async function D(e){try{const t={userId:c,courseId:i,quantity:e,status:"purchase",isNextPurchase:!1,dueDate:""};await r.post("http://localhost:3000/myCarts",t,{headers:{"Content-Type":"application/json"}}),await C(),f()}catch(t){console.log("getMyCarts",t)}}async function $(e,t){try{let{id:a,quantity:o,isNextPurchase:n}=e,s={};n?s={isNextPurchase:!1,quantity:t===1?o:t}:(o=Number(o)+1,s={quantity:t===1?o++:t}),await r.patch(`http://localhost:3000/myCarts/${a}`,s,{headers:{"Content-Type":"application/json"}})}catch(a){console.log("getMyCarts",a)}}async function I(){if(!p)try{await Promise.all(d.map(e=>T(e)))}catch(e){console.error("Error adding coupons:",e)}}async function T(e){try{let t=e.id,a=e.discountCourseNum*7,o=Date.now(),n=new Date(o);n.setDate(n.getDate()+a),n.setHours(23,59,59,999);let s={userId:c,couponId:t,canUse:!0,timestamp:o,dueDate:n};await r.post("http://localhost:3000/myCoupons",s,{headers:{"Content-Type":"application/json"}})}catch(t){console.log("addCoupon",t)}}export{B as h};
