import{i as C,u as c,a as r,g as h,r as f}from"./backtotop-9d7c375e.js";let i;const u=Swal.mixin({icon:"success",toast:!0,position:"top-end",showConfirmButton:!1,timer:2e3});let d,m,l,p;function T(e){document.addEventListener("DOMContentLoaded",()=>{e.addEventListener("click",async t=>{if(t.target.dataset.course&&t.target.type==="button")if(C){i=t.target.dataset.course;const n=Number(t.target.dataset.quantity)||1;await y(),p=m.find(o=>o.couponId==l[0].id)!==void 0,j(n),$(),g()}else{let a=function(){o&&(n==0&&(location.href="./login.html"),document.getElementById("timeBox").innerHTML=n,n-=1,setTimeout(a,1e3))},n=5,o=!0;document.getElementById("timeBox").innerHTML=n,document.querySelector("#btn-close").addEventListener("click",function(){o=!1}),a()}})})}async function y(){try{const e=`https://project-code-json-k0ti.onrender.com/myCarts?userId=${c}&courseId=${i}&status=purchase`,t=`https://project-code-json-k0ti.onrender.com/myCoupons?userId=${c}`,n=`https://project-code-json-k0ti.onrender.com/coupons?courseId=${i}`,o=await Promise.all([r.get(e),r.get(t),r.get(n)]);d=o[0].data,m=o[1].data,l=o[2].data}catch{console.log("getStartCourseData",y)}}async function g(){p?u.fire({title:"將課程加入購物車"}):(await u.fire({title:"將課程加入購物車"}),u.fire({title:"首次加入購物車，獲得「體驗課優惠券」、「多堂折價優惠券」"}))}function j(e){d.length?D(d[0],e):w(e)}async function w(e){try{const t={userId:c,courseId:i,quantity:e,status:"purchase",isNextPurchase:!1,dueDate:""};await r.post("https://project-code-json-k0ti.onrender.com/myCarts",t,{headers:{"Content-Type":"application/json"}}),await h(),f()}catch(t){console.log("getMyCarts",t)}}async function D(e,t){try{let{id:n,quantity:o,isNextPurchase:s}=e,a={};s?a={isNextPurchase:!1,quantity:t===1?o:t}:(o=Number(o)+1,a={quantity:t===1?o++:t}),await r.patch(`https://project-code-json-k0ti.onrender.com/myCarts/${n}`,a,{headers:{"Content-Type":"application/json"}})}catch(n){console.log("getMyCarts",n)}}async function $(){if(!p)try{await Promise.all(l.map(e=>k(e)))}catch(e){console.error("Error adding coupons:",e)}}async function k(e){try{let t=e.id,n=e.discountCourseNum*7,o=Date.now(),s=new Date(o);s.setDate(s.getDate()+n),s.setHours(23,59,59,999);let a={userId:c,couponId:t,canUse:!0,timestamp:o,dueDate:s};await r.post("https://project-code-json-k0ti.onrender.com/myCoupons",a,{headers:{"Content-Type":"application/json"}})}catch(t){console.log("addCoupon",t)}}export{T as h};
